<?php
 function ByteArray2Bits($aData,&$aBits,$aWordSize=8) { $resIdx = 0; $n = count($aData); $maskbit = 1 << ($aWordSize-1); $mask = (1 << $aWordSize)-1; for($i=0; $i < $n; ++$i) { $b = $aData[$i]; for($j=0; $j < $aWordSize; ++$j) { if( $b & $maskbit ) $aBits[$resIdx++] = 1; else $aBits[$resIdx++] = 0; $b = ($b << 1) & $mask; } } } function Word2Bits($aByte,&$aBits,$aWordSize=8) { $resIdx = 0; $aBits = array(); $maskbit = 1 << ($aWordSize-1); $mask = (1 << $aWordSize)-1; $b = $aByte; for($j=0; $j < $aWordSize; ++$j) { if( $b & $maskbit ) $aBits[$resIdx++] = 1; else $aBits[$resIdx++] = 0; $b = ($b << 1) & $mask; } } function tilde_process($aStr) { $r = str_replace('~@',chr(0),$aStr); for($i=0; $i < 26; ++$i ) { $r = str_replace('~'.chr($i+65),chr($i+1),$r); } if( ($n = strpos($r,'~1')) !== false ) { if( $n == 0 || $n == 1 || $n == 4 || $n == 5 ) $r = str_replace('~1',chr(232),$r); else $r = str_replace('~1',chr(29),$r); } if( ($n = strpos($r,'~2')) !== false ) { if( $n == 0 ) { if( strpos($r,'~2',$n+2) === false ) { $nn = substr($r,2,2); if( !ctype_digit($nn) ) return false; $mm = substr($r,4,2); if( !ctype_digit($mm) ) return false; if( $nn < 1 || $mm < 2 || $mm > 16 || $nn > $mm ) return false; $mm = 17-$mm; $nn = $nn-1; $ff1 = substr($r,6,3); $ff2 = substr($r,9,3); if( !ctype_digit($ff1) || !ctype_digit($ff2) ) return false; $rr = chr(233).chr(($nn << 4) | $mm).chr($ff1).chr($ff2); $r = $rr.substr($r,12) ; } else return false; } else return false; } if( ($n = strpos($r,'~5')) !== false ) { if( $n == 0 ) { if( strpos($r,'~5',$n+2) === false ) $r = str_replace('~5',chr(236),$r); else return false; } else return false; } if( ($n = strpos($r,'~6')) !== false ) { if( $n == 0 ) { if( strpos($r,'~6',$n+2) === false ) $r = str_replace('~6',chr(237),$r); else return false; } else return false; } if( ($n = strpos($r,'~9')) !== false ) { if( $n == 0 ) { if( strpos($r,'~9',$n+2) === false ) $r = str_replace('~9',chr(234),$r); else return false; } else return false; } $offset=0; while( ($n = strpos($r,'~7',$offset)) !== false ) { $seci = substr($r,$n+2,6); if( strlen($seci) < 6 || !is_numeric($seci)) return false; $eci = intval($seci); if( $eci >= 0 && $eci <= 126 ) { $code = chr(241).chr($eci+1); } elseif( $eci >= 127 && $eci <= 16382 ) { $c1 = floor(($eci-127)/254) + 128; $c2 = ($eci-127) % 254 + 1; $code = chr(241).chr($c1).chr($c2); } else { $c1 = floor(($eci-16383)/64516) + 192; $c2 = floor(($eci-16383)/254) % 254 + 1; $c3 = ($eci-16383) % 254 + 1; $code = chr(241).chr($c1).chr($c2).chr($c3); } $r = str_replace('~7'.$seci,$code,$r); $offset = $n+strlen($code); } $offset=0; while( ($n = strpos($r,'~d',$offset)) !== false ) { $sv = substr($r,$n+2,3); if( strlen($sv) < 3 || !ctype_digit($sv)) return false; $v = intval($sv); $r = str_replace('~d'.$sv,chr($v),$r); $offset = $n+1; } return $r; } ?>
